<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            html,
            body,
            #container {
                margin: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div id="container"></div>
        <script src="https://mapgl.2gis.com/api/js/v1"></script>
        <script src="https://unpkg.com/@2gis/mapgl-directions@^2/dist/directions.js"></script>
        <script>
            const key = 'b00acc71-94a2-40c6-b6cd-ecd26e772ece';
            const map = new mapgl.Map('container', {
                center: [37.621447, 55.75353],
                zoom: 12,
                key: key,
            });
            map.setLanguage('ru');
            
            const directions = new mapgl.Directions(map, {
                directionsApiKey: key,
            });
            const markers = [];
            const markersCoords = [];
            var routeBuilt = false;
            var distance = 0;
            var duration = 0;
            var elevationGain = 0;
            var elevationLoss = 0;

            function clearRoute() {
                markersCoords.length = 0;
                directions.clear();
                routeBuilt = false;
                markers.forEach((m) => {
                    m.destroy();
                });
                markers.length = 0;
            };

            map.on('click', (e) => {
                if (routeBuilt) return;
                const coords = e.lngLat;
                markers.push(
                    new mapgl.Marker(map, {
                        coordinates: coords
                    }),
                );

                markersCoords.push(coords);
            });
          
            function buildRoute() {
                if (routeBuilt) return;
                try { directions.pedestrianRoute({ points: markersCoords }) }
                catch { return; }
                const url = "https://routing.api.2gis.com/routing/7.0.0/global?key=" + key;
                const requestData = {
                  "points": [],
                  "transport": "walking",
                  "need_altitudes": true,
                  "output": "detailed",
                  "locale": "ru",
                };
                requestData.points.push({
                    "lon": markersCoords[0][0],
                    "lat": markersCoords[0][1],
                    "type": "walking",
                });
                for (let i = 1; i < markersCoords.length - 1; i++) {
                    requestData.points.push({
                        "lon": markersCoords[i][0],
                        "lat": markersCoords[i][1],
                        "type": "pref",
                    });
                }
                requestData.points.push({
                    "lon": markersCoords[markersCoords.length - 1][0],
                    "lat": markersCoords[markersCoords.length - 1][1],
                    "type": "walking",
                });
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, false);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify(requestData));
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    console.log(data);
                    distance = data.result[0].total_distance;
                    duration = data.result[0].total_duration;
                    elevationGain = data.result[0].altitudes_info.elevation_gain;
                    elevationLoss = data.result[0].altitudes_info.elevation_loss;
                }
                markers.forEach((m) => {
                    m.destroy();
                });
                markers.length = 0;
                routeBuilt = true;
                
                return JSON.stringify({
                    markersCoords,
                    distance,
                    duration,
                    elevationGain,
                    elevationLoss,
                });
            }
          
            function findPlace(name) { 
              
                const url = "https://api.geoapify.com/v1/geocode/search?&apiKey=c32305898526472b992859684bab2fc7&text=" + encodeURIComponent(name);

                fetch(url, { method: "GET" })
                    .then(response => response.json())
                    .then(result => {
                        if (result.features && result.features.length > 0) {
                            const firstFeature = result.features[0];
                            const lat = firstFeature.properties.lat;
                            const lon = firstFeature.properties.lon;
            
                            map.setCenter([lon, lat]);
                        }
                    });
            }
          
        </script>
    </body>
</html>